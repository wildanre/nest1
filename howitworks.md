# How It Works - NestJS Authentication Backend

## Arsitektur Sistem

Aplikasi ini menggunakan arsitektur **NestJS** dengan pola **Module-Based Architecture** yang terdiri dari beberapa modul utama:

```
nest1/ (Root Project)
‚îú‚îÄ‚îÄ üìÑ Configuration Files
‚îÇ   ‚îú‚îÄ‚îÄ package.json              # Dependencies & scripts
‚îÇ   ‚îú‚îÄ‚îÄ nest-cli.json            # NestJS CLI configuration
‚îÇ   ‚îú‚îÄ‚îÄ tsconfig.json            # TypeScript configuration
‚îÇ   ‚îú‚îÄ‚îÄ .env                     # Environment variables
‚îÇ   ‚îî‚îÄ‚îÄ eslint.config.mjs        # ESLint configuration
‚îÇ
‚îú‚îÄ‚îÄ üìö Documentation
‚îÇ   ‚îú‚îÄ‚îÄ README.md                # Project overview
‚îÇ   ‚îú‚îÄ‚îÄ API_DOCUMENTATION.md     # API endpoints documentation
‚îÇ   ‚îú‚îÄ‚îÄ howitworks.md           # Backend architecture guide (this file)
‚îÇ   ‚îú‚îÄ‚îÄ TEST_ENDPOINTS.md       # Testing guide
‚îÇ   ‚îú‚îÄ‚îÄ CLOUD_DATABASE_SETUP.md # Database setup guide
‚îÇ   ‚îî‚îÄ‚îÄ FRONTEND_TESTING.md     # Frontend testing guide
‚îÇ
‚îú‚îÄ‚îÄ üöÄ Source Code (src/)
‚îÇ   ‚îú‚îÄ‚îÄ main.ts                  # Application entry point
‚îÇ   ‚îú‚îÄ‚îÄ app.module.ts           # Root application module
‚îÇ   ‚îú‚îÄ‚îÄ app.controller.ts       # Root controller
‚îÇ   ‚îú‚îÄ‚îÄ app.service.ts          # Root service
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ üîê auth/ (Authentication Module)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth.module.ts       # Auth module configuration
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth.controller.ts   # HTTP endpoints handler
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth.service.ts      # Business logic
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ dto/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ auth.dto.ts      # Data transfer objects
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ guards/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ jwt-auth.guard.ts    # JWT protection
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ local-auth.guard.ts  # Local auth
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ strategies/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ jwt.strategy.ts      # JWT strategy
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ local.strategy.ts    # Local strategy
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ üë• users/ (Users Module)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ users.module.ts      # Users module configuration
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ users.service.ts     # User database operations
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ user.entity.ts       # User database entity
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ üìß email/ (Email Module)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ email.module.ts      # Email module configuration
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ email.service.ts     # Email sending operations
‚îÇ   ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ ‚öôÔ∏è config/
‚îÇ       ‚îî‚îÄ‚îÄ database.config.ts   # Database configuration
‚îÇ
‚îú‚îÄ‚îÄ üß™ Testing
‚îÇ   ‚îú‚îÄ‚îÄ test/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ app.e2e-spec.ts     # End-to-end tests
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ jest-e2e.json       # Jest E2E configuration
‚îÇ   ‚îî‚îÄ‚îÄ src/**/*.spec.ts        # Unit tests
‚îÇ
‚îî‚îÄ‚îÄ üåê Frontend (Optional)
    ‚îî‚îÄ‚îÄ frontend/
        ‚îú‚îÄ‚îÄ index.html          # Main HTML file
        ‚îú‚îÄ‚îÄ styles.css          # Styling
        ‚îî‚îÄ‚îÄ script.js           # JavaScript logic
```

---

## 1. Database Schema & Design

### Neon PostgreSQL Cloud Database
Menggunakan **Neon PostgreSQL** sebagai database cloud dengan konfigurasi:
- **Host**: `ep-weathered-star-a1jqmeil-pooler.ap-southeast-1.aws.neon.tech`
- **SSL**: Required
- **Connection Pooling**: Enabled
- **Auto-scaling**: Serverless PostgreSQL

### User Entity (`src/users/user.entity.ts`)
```typescript
@Entity('users')
export class User {
  @PrimaryGeneratedColumn('uuid')
  id: string;

  @Column({ unique: true })
  email: string;

  @Column()
  password: string;

  @Column()
  firstName: string;

  @Column()
  lastName: string;

  @Column({ default: false })
  isEmailVerified: boolean;

  @Column({ default: true })
  isActive: boolean;

  // 6-digit verification codes
  @Column({ type: 'varchar', length: 6, nullable: true })
  emailVerificationCode: string;

  @Column({ type: 'varchar', length: 6, nullable: true })
  passwordResetCode: string;

  @CreateDateColumn()
  createdAt: Date;

  @UpdateDateColumn()
  updatedAt: Date;
}
```

**Perubahan Penting:**
- ‚ùå `emailVerificationToken` (string panjang)
- ‚úÖ `emailVerificationCode` (6 digit varchar)
- ‚ùå `passwordResetToken` (string panjang)
- ‚úÖ `passwordResetCode` (6 digit varchar)

---

## 2. Struktur Folder & File

### üìÅ `src/auth/` - Authentication Module

#### `auth.module.ts` - Module Configuration
```typescript
@Module({
  imports: [
    UsersModule,           // Import users module
    EmailModule,           // Import email module
    PassportModule,        // Passport authentication
    JwtModule.registerAsync({
      imports: [ConfigModule],
      useFactory: async (configService: ConfigService) => ({
        secret: configService.get<string>('JWT_SECRET'),
        signOptions: { expiresIn: '24h' },
      }),
      inject: [ConfigService],
    }),
  ],
  controllers: [AuthController],
  providers: [AuthService, JwtStrategy],
  exports: [AuthService],
})
```

#### `auth.controller.ts` - HTTP Endpoints
Menangani semua HTTP requests untuk authentication:

```typescript
@Controller('auth')
export class AuthController {
  // POST /auth/register
  @Post('register')
  async register(@Body() registerDto: RegisterDto)

  // POST /auth/login
  @Post('login')
  async login(@Body() loginDto: LoginDto)

  // POST /auth/verify-email
  @Post('verify-email')
  async verifyEmail(@Body() verifyEmailDto: VerifyEmailDto)

  // POST /auth/forgot-password
  @Post('forgot-password')
  async forgotPassword(@Body() forgotPasswordDto: ForgotPasswordDto)

  // POST /auth/reset-password
  @Post('reset-password')
  async resetPassword(@Body() resetPasswordDto: ResetPasswordDto)

  // POST /auth/resend-verification
  @Post('resend-verification')
  async resendVerification(@Body() resendVerificationDto: ResendVerificationDto)

  // GET /auth/profile (Protected with JWT)
  @UseGuards(JwtAuthGuard)
  @Get('profile')
  async getProfile(@Request() req)

  // POST /auth/logout (Protected with JWT)
  @UseGuards(JwtAuthGuard)
  @Post('logout')
  async logout(@Request() req)
}
```

#### `auth.service.ts` - Business Logic
Menangani semua logic bisnis authentication:

```typescript
@Injectable()
export class AuthService {
  // Registrasi user baru
  async register(registerDto: RegisterDto) {
    // 1. Hash password dengan bcrypt
    // 2. Generate 6-digit verification code
    // 3. Simpan user ke database
    // 4. Kirim email verification
    // 5. Return user data (tanpa password)
  }

  // Login user
  async login(loginDto: LoginDto) {
    // 1. Validasi email & password
    // 2. Check apakah email sudah diverifikasi
    // 3. Generate JWT token
    // 4. Return token & user data
  }

  // Verifikasi email dengan 6-digit code
  async verifyEmail(verifyEmailDto: VerifyEmailDto) {
    // 1. Cari user berdasarkan verification code
    // 2. Validasi code masih valid
    // 3. Update isEmailVerified = true
    // 4. Clear verification code
  }

  // Request password reset
  async forgotPassword(forgotPasswordDto: ForgotPasswordDto) {
    // 1. Cari user berdasarkan email
    // 2. Generate 6-digit reset code
    // 3. Simpan reset code ke database
    // 4. Kirim email dengan reset code
  }

  // Reset password dengan code
  async resetPassword(resetPasswordDto: ResetPasswordDto) {
    // 1. Cari user berdasarkan reset code
    // 2. Validasi code masih valid
    // 3. Hash password baru
    // 4. Update password & clear reset code
  }
}
```

#### `dto/auth.dto.ts` - Data Transfer Objects
Validasi input dari client:

```typescript
export class RegisterDto {
  @IsEmail()
  email: string;

  @IsString()
  @MinLength(6)
  password: string;

  @IsString()
  firstName: string;

  @IsString()
  lastName: string;
}

export class VerifyEmailDto {
  @IsString()
  @Length(6, 6)
  @Matches(/^\d{6}$/) // Hanya 6 digit angka
  code: string;
}

export class ResetPasswordDto {
  @IsString()
  @Length(6, 6)
  @Matches(/^\d{6}$/) // Hanya 6 digit angka
  code: string;

  @IsString()
  @MinLength(6)
  newPassword: string;
}
```

### üìÅ `src/users/` - Users Module

#### `users.service.ts` - User Database Operations
```typescript
@Injectable()
export class UsersService {
  // Generate 6-digit random code
  private generateCode(): string {
    return Math.floor(100000 + Math.random() * 900000).toString();
  }

  // Create user baru
  async create(createUserDto: CreateUserDto): Promise<User> {
    const code = this.generateCode();
    const user = this.userRepository.create({
      ...createUserDto,
      emailVerificationCode: code,
    });
    return await this.userRepository.save(user);
  }

  // Generate verification code baru
  async generateEmailVerificationCode(userId: string): Promise<string> {
    const code = this.generateCode();
    await this.userRepository.update(userId, {
      emailVerificationCode: code,
    });
    return code;
  }

  // Generate password reset code
  async generatePasswordResetCode(userId: string): Promise<string> {
    const code = this.generateCode();
    await this.userRepository.update(userId, {
      passwordResetCode: code,
    });
    return code;
  }

  // Cari user berdasarkan verification code
  async findByEmailVerificationCode(code: string): Promise<User> {
    return await this.userRepository.findOne({
      where: { emailVerificationCode: code }
    });
  }

  // Cari user berdasarkan reset code
  async findByPasswordResetCode(code: string): Promise<User> {
    return await this.userRepository.findOne({
      where: { passwordResetCode: code }
    });
  }
}
```

### üìÅ `src/email/` - Email Module

#### `email.service.ts` - Email Operations
```typescript
@Injectable()
export class EmailService {
  private transporter;

  constructor(private configService: ConfigService) {
    this.transporter = nodemailer.createTransporter({
      host: this.configService.get('EMAIL_HOST'),
      port: this.configService.get('EMAIL_PORT'),
      secure: false,
      auth: {
        user: this.configService.get('EMAIL_USER'),
        pass: this.configService.get('EMAIL_PASS'),
      },
    });
  }

  // Kirim email verification dengan 6-digit code
  async sendVerificationEmail(email: string, code: string) {
    const htmlTemplate = `
      <div style="max-width: 600px; margin: 0 auto; font-family: Arial;">
        <h2>Verify Your Email</h2>
        <p>Your 6-digit verification code is:</p>
        <div style="font-size: 32px; font-weight: bold; color: #007bff; 
                    text-align: center; padding: 20px; background: #f8f9fa; 
                    border-radius: 8px; letter-spacing: 8px;">
          ${code}
        </div>
        <p>This code is valid for email verification.</p>
      </div>
    `;

    await this.transporter.sendMail({
      from: this.configService.get('EMAIL_FROM'),
      to: email,
      subject: 'Verify Your Email - Your 6-Digit Code',
      html: htmlTemplate,
    });
  }

  // Kirim email password reset dengan 6-digit code
  async sendPasswordResetEmail(email: string, code: string) {
    const htmlTemplate = `
      <div style="max-width: 600px; margin: 0 auto; font-family: Arial;">
        <h2>Reset Your Password</h2>
        <p>Your 6-digit password reset code is:</p>
        <div style="font-size: 32px; font-weight: bold; color: #dc3545; 
                    text-align: center; padding: 20px; background: #f8f9fa; 
                    border-radius: 8px; letter-spacing: 8px;">
          ${code}
        </div>
        <p>Use this code to reset your password.</p>
      </div>
    `;

    await this.transporter.sendMail({
      from: this.configService.get('EMAIL_FROM'),
      to: email,
      subject: 'Reset Your Password - Your 6-Digit Code',
      html: htmlTemplate,
    });
  }
}
```

---

## 3. Alur Kerja (Workflow)

### üîÑ **Flow 1: User Registration**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    POST /auth/register    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Client    ‚îÇ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚Üí ‚îÇ AuthController  ‚îÇ
‚îÇ  (Frontend) ‚îÇ                           ‚îÇ   .register()   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                           ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                                   ‚îÇ
                                                   ‚ñº
                                          ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                                          ‚îÇ   AuthService   ‚îÇ
                                          ‚îÇ   .register()   ‚îÇ
                                          ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                                   ‚îÇ
                                   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                                   ‚ñº               ‚ñº               ‚ñº
                            ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                            ‚îÇ   bcrypt    ‚îÇ ‚îÇ UsersService‚îÇ ‚îÇEmailService ‚îÇ
                            ‚îÇ .hash(pwd)  ‚îÇ ‚îÇ  .create()  ‚îÇ ‚îÇ.sendVerify()‚îÇ
                            ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                                   ‚îÇ               ‚îÇ
                                                   ‚ñº               ‚ñº
                                          ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                                          ‚îÇ PostgreSQL DB   ‚îÇ ‚îÇ Gmail SMTP  ‚îÇ
                                          ‚îÇ Save User +     ‚îÇ ‚îÇ Send Email  ‚îÇ
                                          ‚îÇ 6-digit Code    ‚îÇ ‚îÇ with Code   ‚îÇ
                                          ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### üîÑ **Flow 2: Email Verification**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                          ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ    User     ‚îÇ ‚Üê Email with 6-digit ‚îÄ‚îÄ‚îÄ‚îÄ ‚îÇ EmailService    ‚îÇ
‚îÇ Gets Email  ‚îÇ    Code: "123456"         ‚îÇ (Gmail SMTP)    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                          ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚îÇ User inputs code in frontend
       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   POST /auth/verify-email ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Client    ‚îÇ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚Üí ‚îÇ AuthController  ‚îÇ
‚îÇ  (Frontend) ‚îÇ   { code: "123456" }      ‚îÇ  .verifyEmail() ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                           ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                                   ‚îÇ
                                                   ‚ñº
                                          ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                                          ‚îÇ   AuthService   ‚îÇ
                                          ‚îÇ  .verifyEmail() ‚îÇ
                                          ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                                   ‚îÇ
                                                   ‚ñº
                                          ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                                          ‚îÇ UsersService    ‚îÇ
                                          ‚îÇ.findByEmailCode ‚îÇ
                                          ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                                   ‚îÇ
                                                   ‚ñº
                                          ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                                          ‚îÇ PostgreSQL DB   ‚îÇ
                                          ‚îÇ UPDATE users    ‚îÇ
                                          ‚îÇ SET verified=true‚îÇ
                                          ‚îÇ code=null       ‚îÇ
                                          ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### üîÑ **Flow 3: User Login**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     POST /auth/login      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Client    ‚îÇ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚Üí ‚îÇ AuthController  ‚îÇ
‚îÇ  (Frontend) ‚îÇ  { email, password }      ‚îÇ    .login()     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                           ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                                   ‚îÇ
                                                   ‚ñº
                                          ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                                          ‚îÇ   AuthService   ‚îÇ
                                          ‚îÇ    .login()     ‚îÇ
                                          ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                                   ‚îÇ
                                   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                                   ‚ñº               ‚ñº               ‚ñº
                            ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                            ‚îÇUsersService ‚îÇ ‚îÇ   bcrypt    ‚îÇ ‚îÇ JwtService  ‚îÇ
                            ‚îÇ.findByEmail ‚îÇ ‚îÇ .compare()  ‚îÇ ‚îÇ  .sign()    ‚îÇ
                            ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                   ‚îÇ               ‚îÇ               ‚îÇ
                                   ‚ñº               ‚ñº               ‚ñº
                            ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                            ‚îÇPostgreSQL DB‚îÇ ‚îÇ Password    ‚îÇ ‚îÇ JWT Token   ‚îÇ
                            ‚îÇ Get User    ‚îÇ ‚îÇ Validation  ‚îÇ ‚îÇ Generated   ‚îÇ
                            ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                                                   ‚îÇ
                                                                   ‚ñº
                                                          ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                                                          ‚îÇ Return to Client‚îÇ
                                                          ‚îÇ { access_token, ‚îÇ
                                                          ‚îÇ   user_data }   ‚îÇ
                                                          ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### üîÑ **Flow 4: Password Reset (2-Step Process)**

#### Step 1: Request Reset Code
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  POST /auth/forgot-password ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Client    ‚îÇ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚Üí  ‚îÇ AuthController  ‚îÇ
‚îÇ  (Frontend) ‚îÇ    { email }               ‚îÇ.forgotPassword()‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                            ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                                    ‚îÇ
                                                    ‚ñº
                                           ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                                           ‚îÇ   AuthService   ‚îÇ
                                           ‚îÇ.forgotPassword()‚îÇ
                                           ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                                    ‚îÇ
                                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                                    ‚ñº               ‚ñº               ‚ñº
                            ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                            ‚îÇUsersService ‚îÇ ‚îÇUsersService ‚îÇ ‚îÇEmailService ‚îÇ
                            ‚îÇ.findByEmail ‚îÇ ‚îÇ.generateReset‚îÇ ‚îÇ.sendReset() ‚îÇ
                            ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                    ‚îÇ               ‚îÇ               ‚îÇ
                                    ‚ñº               ‚ñº               ‚ñº
                            ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                            ‚îÇPostgreSQL DB‚îÇ ‚îÇPostgreSQL DB‚îÇ ‚îÇ Gmail SMTP  ‚îÇ
                            ‚îÇ Find User   ‚îÇ ‚îÇ Save Reset  ‚îÇ ‚îÇ Send Email  ‚îÇ
                            ‚îÇ             ‚îÇ ‚îÇ Code        ‚îÇ ‚îÇ with Code   ‚îÇ
                            ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

#### Step 2: Reset with Code
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                          ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ    User     ‚îÇ ‚Üê Email with reset ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ ‚îÇ EmailService    ‚îÇ
‚îÇ Gets Email  ‚îÇ    Code: "123456"        ‚îÇ (Gmail SMTP)    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                          ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚îÇ User inputs code + new password
       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  POST /auth/reset-password ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Client    ‚îÇ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚Üí ‚îÇ AuthController  ‚îÇ
‚îÇ  (Frontend) ‚îÇ{ code, newPassword }      ‚îÇ .resetPassword()‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                           ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                                   ‚îÇ
                                                   ‚ñº
                                          ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                                          ‚îÇ   AuthService   ‚îÇ
                                          ‚îÇ .resetPassword()‚îÇ
                                          ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                                   ‚îÇ
                                   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                                   ‚ñº               ‚ñº               ‚ñº
                            ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                            ‚îÇUsersService ‚îÇ ‚îÇ   bcrypt    ‚îÇ ‚îÇUsersService ‚îÇ
                            ‚îÇ.findByReset ‚îÇ ‚îÇ .hash(new)  ‚îÇ ‚îÇ .update()   ‚îÇ
                            ‚îÇ    Code     ‚îÇ ‚îÇ  password   ‚îÇ ‚îÇ  password   ‚îÇ
                            ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                   ‚îÇ               ‚îÇ               ‚îÇ
                                   ‚ñº               ‚ñº               ‚ñº
                            ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                            ‚îÇPostgreSQL DB‚îÇ ‚îÇ Hashed Pass ‚îÇ ‚îÇPostgreSQL DB‚îÇ
                            ‚îÇ Find User   ‚îÇ ‚îÇ Generated   ‚îÇ ‚îÇ Update Pass ‚îÇ
                            ‚îÇ by Code     ‚îÇ ‚îÇ             ‚îÇ ‚îÇ Clear Code  ‚îÇ
                            ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### üîÑ **Flow 5: Protected Routes (JWT Authentication)**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    GET /auth/profile      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Client    ‚îÇ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚Üí ‚îÇ JwtAuthGuard    ‚îÇ
‚îÇ  (Frontend) ‚îÇ Authorization: Bearer     ‚îÇ (Middleware)    ‚îÇ
‚îÇ             ‚îÇ <jwt_token>               ‚îÇ                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                           ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                                   ‚îÇ
                                                   ‚ñº
                                          ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                                          ‚îÇ  JwtStrategy    ‚îÇ
                                          ‚îÇ .validate()     ‚îÇ
                                          ‚îÇ Decode Token    ‚îÇ
                                          ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                                   ‚îÇ
                                                   ‚ñº
                                          ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                                          ‚îÇ AuthController  ‚îÇ
                                          ‚îÇ .getProfile()   ‚îÇ
                                          ‚îÇ (Protected)     ‚îÇ
                                          ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                                   ‚îÇ
                                                   ‚ñº
                                          ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                                          ‚îÇ Return User     ‚îÇ
                                          ‚îÇ Profile Data    ‚îÇ
                                          ‚îÇ (No Password)   ‚îÇ
                                          ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## 4. Security Features

### üîê **Password Security**
- **bcrypt hashing** dengan salt rounds (default 10)
- **Minimum 6 characters** untuk password
- Password tidak pernah di-return dalam response

### üîê **JWT Token Security**
- **24 jam expiry** untuk access token
- **Secret key** dari environment variables
- **Bearer token** authentication
- Token validation pada protected routes

### üîê **6-Digit Code Security**
- **Random generation** menggunakan `Math.random()`
- **6 digit angka** (100000-999999)
- **Single use** - code dihapus setelah digunakan
- **No expiry time** - valid sampai digunakan

### üîê **Input Validation**
- **class-validator** untuk validasi DTO
- **Email format** validation
- **Code format** validation (exactly 6 digits)
- **SQL injection** protection via TypeORM

### üîê **Database Security**
- **SSL connection** ke Neon PostgreSQL
- **Connection pooling** untuk performance
- **Environment variables** untuk credentials
- **UUID primary keys** untuk better security

---

## 5. Configuration & Environment

### üìù **Environment Variables (`.env`)**
```env
# Database Configuration
DATABASE_URL=postgresql://user:pass@host:5432/db?sslmode=require

# JWT Configuration
JWT_SECRET=your-super-secret-jwt-key

# Email Configuration (Gmail SMTP)
EMAIL_HOST=smtp.gmail.com
EMAIL_PORT=587
EMAIL_USER=your-email@gmail.com
EMAIL_PASS=your-app-password
EMAIL_FROM=your-email@gmail.com
```

### üìù **Main Configuration (`main.ts`)**
```typescript
async function bootstrap() {
  const app = await NestFactory.create(AppModule);
  
  // CORS Configuration
  app.enableCors({
    origin: [
      'http://localhost:3000',
      'http://127.0.0.1:3000',
      /^file:\/\//  // Allow local file protocol
    ],
    credentials: true,
  });
  
  // Global validation pipe
  app.useGlobalPipes(new ValidationPipe({
    whitelist: true,
    forbidNonWhitelisted: true,
    transform: true,
  }));
  
  await app.listen(3000);
}
```

---

## 6. Keunggulan Sistem 6-Digit Code

### ‚úÖ **Vs Email Links (Token-based)**
| Feature | 6-Digit Code | Email Links |
|---------|--------------|-------------|
| **Security** | ‚úÖ Shorter, harder to guess | ‚ùå Long tokens in URL |
| **UX** | ‚úÖ Copy-paste friendly | ‚ùå Click dependency |
| **Mobile** | ‚úÖ Easy to read on mobile | ‚ùå Link formatting issues |
| **Email Clients** | ‚úÖ No link blocking | ‚ùå Often blocked |
| **Expiry** | ‚úÖ Single use | ‚ùå Time-based expiry |

### ‚úÖ **Benefits**
- **Better Security**: Codes tidak bisa di-guess atau di-brute force
- **Better UX**: User tinggal copy-paste, tidak perlu klik link
- **Mobile Friendly**: Mudah dibaca di aplikasi email mobile
- **No URL Issues**: Tidak ada masalah dengan email client yang block links
- **Simpler Logic**: Tidak perlu handle expiry time, langsung invalid setelah digunakan

---

## 7. Testing & Debugging

### üß™ **Manual Testing Endpoints**
```bash
# Register
curl -X POST http://localhost:3000/auth/register \
  -H "Content-Type: application/json" \
  -d '{"email":"test@test.com","password":"123456","firstName":"Test","lastName":"User"}'

# Verify Email (check your email for code)
curl -X POST http://localhost:3000/auth/verify-email \
  -H "Content-Type: application/json" \
  -d '{"code":"123456"}'

# Login
curl -X POST http://localhost:3000/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"test@test.com","password":"123456"}'
```

### üêõ **Common Issues & Solutions**
1. **Database Connection**: Check DATABASE_URL format
2. **Email Not Sending**: Verify Gmail app password
3. **CORS Error**: Check frontend origin in CORS config
4. **JWT Error**: Verify JWT_SECRET is set
5. **Code Not Working**: Check 6-digit format validation

---

## 8. Deployment Ready

Sistem ini siap untuk production dengan:
- ‚úÖ **Cloud Database** (Neon PostgreSQL)
- ‚úÖ **Environment Variables** for security
- ‚úÖ **Error Handling** yang konsisten
- ‚úÖ **Input Validation** lengkap
- ‚úÖ **CORS** configuration
- ‚úÖ **JWT** authentication
- ‚úÖ **Email Templates** yang styled
- ‚úÖ **Frontend** yang responsive

---

## 9. Dependency Injection & Module Relationships

### üîó **Module Dependencies Map**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                        AppModule                            ‚îÇ
‚îÇ                     (Root Module)                           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                  ‚îÇ               ‚îÇ
                  ‚ñº               ‚ñº
         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
         ‚îÇ   ConfigModule  ‚îÇ ‚îÇ TypeOrmModule   ‚îÇ
         ‚îÇ (Environment)   ‚îÇ ‚îÇ  (Database)     ‚îÇ
         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                  ‚îÇ               ‚îÇ
                  ‚ñº               ‚ñº
         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
         ‚îÇ            AuthModule               ‚îÇ
         ‚îÇ        (Authentication)             ‚îÇ
         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                       ‚îÇ
          ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
          ‚ñº            ‚ñº            ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ UsersModule ‚îÇ ‚îÇEmailModule  ‚îÇ ‚îÇPassportModule‚îÇ
‚îÇ   (Users)   ‚îÇ ‚îÇ  (Email)    ‚îÇ ‚îÇ   (Auth)    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### üîó **Service Dependencies**
```
AuthService
‚îú‚îÄ‚îÄ UsersService (Database operations)
‚îú‚îÄ‚îÄ EmailService (Email sending)
‚îú‚îÄ‚îÄ JwtService (Token generation)
‚îî‚îÄ‚îÄ ConfigService (Environment variables)

UsersService
‚îú‚îÄ‚îÄ UserRepository (TypeORM)
‚îî‚îÄ‚îÄ ConfigService (Database config)

EmailService
‚îú‚îÄ‚îÄ NodeMailer (Email transport)
‚îî‚îÄ‚îÄ ConfigService (SMTP config)
```

### üîó **Provider Injection Examples**
```typescript
// AuthService dependencies
@Injectable()
export class AuthService {
  constructor(
    private usersService: UsersService,      // Users operations
    private emailService: EmailService,     // Email sending
    private jwtService: JwtService,         // JWT token handling
    private configService: ConfigService,   // Environment config
  ) {}
}

// UsersService dependencies
@Injectable()
export class UsersService {
  constructor(
    @InjectRepository(User)
    private userRepository: Repository<User>, // TypeORM repository
  ) {}
}

// EmailService dependencies
@Injectable()
export class EmailService {
  constructor(
    private configService: ConfigService,    // SMTP configuration
  ) {}
}
```

---

## 10. Database Operations Deep Dive

### üìä **TypeORM Repository Pattern**
```typescript
// UsersService menggunakan Repository Pattern
@Injectable()
export class UsersService {
  constructor(
    @InjectRepository(User)
    private userRepository: Repository<User>,
  ) {}

  // CREATE operations
  async create(userData: CreateUserDto): Promise<User> {
    const code = this.generateCode();
    const user = this.userRepository.create({
      ...userData,
      emailVerificationCode: code,
    });
    return await this.userRepository.save(user);
  }

  // READ operations
  async findByEmail(email: string): Promise<User> {
    return await this.userRepository.findOne({
      where: { email },
    });
  }

  async findByEmailVerificationCode(code: string): Promise<User> {
    return await this.userRepository.findOne({
      where: { emailVerificationCode: code },
    });
  }

  // UPDATE operations
  async verifyEmail(userId: string): Promise<void> {
    await this.userRepository.update(userId, {
      isEmailVerified: true,
      emailVerificationCode: null,
    });
  }

  async updatePassword(userId: string, hashedPassword: string): Promise<void> {
    await this.userRepository.update(userId, {
      password: hashedPassword,
      passwordResetCode: null,
    });
  }
}
```

### üìä **Database Queries Generated**
```sql
-- User Registration
INSERT INTO users (
  id, email, password, firstName, lastName, 
  emailVerificationCode, isEmailVerified, isActive, 
  createdAt, updatedAt
) VALUES (
  uuid_generate_v4(), 'user@email.com', '$2b$10$...', 
  'John', 'Doe', '123456', false, true, 
  NOW(), NOW()
);

-- Find by Verification Code
SELECT * FROM users 
WHERE emailVerificationCode = '123456' 
AND isActive = true;

-- Email Verification
UPDATE users 
SET isEmailVerified = true, 
    emailVerificationCode = NULL,
    updatedAt = NOW()
WHERE id = 'user-uuid';

-- Password Reset
UPDATE users 
SET password = '$2b$10$...', 
    passwordResetCode = NULL,
    updatedAt = NOW()
WHERE passwordResetCode = '654321';
```

---

## 11. Error Handling & Validation

### ‚ö†Ô∏è **Exception Filters**
```typescript
// Global Exception Handler
app.useGlobalPipes(new ValidationPipe({
  whitelist: true,           // Remove unknown properties
  forbidNonWhitelisted: true, // Throw error for unknown properties
  transform: true,           // Transform to DTO classes
  exceptionFactory: (errors) => {
    return new BadRequestException(errors);
  },
}));
```

### ‚ö†Ô∏è **Custom Exceptions**
```typescript
// Di AuthService
if (!user) {
  throw new UnauthorizedException('Invalid credentials');
}

if (!user.isEmailVerified) {
  throw new UnauthorizedException('Please verify your email first');
}

if (!user.isActive) {
  throw new UnauthorizedException('Account is deactivated');
}
```

### ‚ö†Ô∏è **DTO Validation**
```typescript
export class RegisterDto {
  @IsEmail({}, { message: 'Please provide a valid email address' })
  email: string;

  @IsString({ message: 'Password must be a string' })
  @MinLength(6, { message: 'Password must be at least 6 characters long' })
  password: string;

  @IsString({ message: 'First name must be a string' })
  @IsNotEmpty({ message: 'First name is required' })
  firstName: string;
}

export class VerifyEmailDto {
  @IsString({ message: 'Code must be a string' })
  @Length(6, 6, { message: 'Code must be exactly 6 digits' })
  @Matches(/^\d{6}$/, { message: 'Code must contain only numbers' })
  code: string;
}
```

---

## 12. Performance & Optimization

### ‚ö° **Connection Pooling**
```typescript
// Database configuration
TypeOrmModule.forRootAsync({
  imports: [ConfigModule],
  useFactory: (configService: ConfigService) => ({
    type: 'postgres',
    url: configService.get('DATABASE_URL'),
    ssl: { rejectUnauthorized: false },
    // Connection pooling for performance
    extra: {
      max: 20,              // Maximum connections in pool
      min: 5,               // Minimum connections in pool
      idle_timeout: 30000,  // Close idle connections after 30s
    },
    synchronize: false,     // Don't auto-sync in production
    logging: false,         // Disable query logging in production
  }),
  inject: [ConfigService],
});
```

### ‚ö° **Caching Strategy**
```typescript
// Future implementation ideas
@Injectable()
export class UsersService {
  // Cache frequently accessed users
  private userCache = new Map<string, User>();

  async findByEmail(email: string): Promise<User> {
    // Check cache first
    if (this.userCache.has(email)) {
      return this.userCache.get(email);
    }
    
    // Fetch from database
    const user = await this.userRepository.findOne({ where: { email } });
    
    // Cache the result
    if (user) {
      this.userCache.set(email, user);
    }
    
    return user;
  }
}
```

### ‚ö° **Email Queue (Future Enhancement)**
```typescript
// For high-volume email sending
import { Queue } from 'bull';

@Injectable()
export class EmailService {
  constructor(
    @InjectQueue('email') private emailQueue: Queue,
  ) {}

  async sendVerificationEmail(email: string, code: string) {
    // Add to queue instead of sending immediately
    await this.emailQueue.add('verification', {
      email,
      code,
      template: 'verification',
    });
  }
}
```
